{{/* Check if this is a submodule page */}}
{{ $isSubmodule := false }}
{{ if or (eq .Section "installation") (eq .Layout "installation") (eq .Section "documentation") (eq .Layout "documentation") (eq .Section "quickstart") (eq .Layout "quickstart") }}
  {{ $isSubmodule = true }}
{{ end }}

{{/* Get processed TOC from scratch for submodules */}}
{{ $toc := "" }}
{{ if $isSubmodule }}
  {{ $toc = .Scratch.Get "processedTOC" }}
{{ else }}
  {{ $toc = .TableOfContents }}
{{ end }}

{{/* Custom TOC generation with proper nesting */}}
{{ $customTOC := "" }}
{{ if $toc }}
  {{ $customTOC = .Scratch.Get "processedTOC" }}
  {{ if not $customTOC }}
    {{/* Process Hugo's TOC to create nested structure */}}
    {{ $customTOC = $toc }}
  {{ end }}
{{ end }}

{{/* Render TOC if available */}}
{{ if $customTOC }}
  <!-- Desktop TOC -->
  <nav class="toc w-80 hidden lg:block flex-shrink-0 mb-0" id="desktop-toc">
    <div class="rounded-2xl shadow-lg flex flex-col sticky top-0" style="background-color: #ffffff;">
      <div class="p-4 border-b border-gray-200 flex-shrink-0">
        <h3 class="text-base font-semibold text-gray-900 mb-0 flex items-center">
          <i class="fas fa-list mr-2 text-primary"></i>
          সূচিপত্র
        </h3>
      </div>
      <div class="toc-content flex-1 overflow-y-auto p-4">
        <div class="nested-toc" id="desktop-toc-container">
          {{ $customTOC | safeHTML }}
        </div>
      </div>
    </div>
  </nav>

  <!-- Mobile TOC Toggle Button Container -->
  <div class="lg:hidden fixed bottom-4 right-4 pointer-events-none">
    <button
      id="toc-mobile-toggle"
      class="bg-primary text-white p-4 rounded-full shadow-2xl hover:bg-primary-dark hover:shadow-3xl transition-all duration-200 backdrop-blur-sm pointer-events-auto border-2 border-white/20">
      <i class="fas fa-list text-lg toc-icon-open"></i>
      <i class="fas fa-times text-lg toc-icon-close hidden"></i>
      <span class="sr-only">সূচিপত্র খুলুন</span>
    </button>
  </div>

  <!-- Mobile TOC Overlay -->
  <div
    id="toc-mobile-overlay"
    class="lg:hidden fixed inset-0 bg-black bg-opacity-50 z-40 opacity-0 invisible transition-all duration-300"></div>

  <!-- Mobile TOC Sheet -->
  <div
    id="toc-mobile-sheet"
    class="lg:hidden fixed top-0 left-0 bottom-0 w-80 max-w-[85vw] shadow-2xl z-50 transform -translate-x-full transition-transform duration-300 ease-in-out" style="background-color: #ffffff;">
    <div class="h-full flex flex-col">
      <div class="p-4 border-b border-gray-200 flex items-center justify-between flex-shrink-0">
        <h3 class="text-base font-semibold text-gray-900 flex items-center">
          <i class="fas fa-list mr-2 text-primary"></i>
          সূচিপত্র
        </h3>
        <button id="toc-mobile-close" class="p-2 text-gray-500 hover:text-gray-700 transition-colors">
          <i class="fas fa-times text-lg"></i>
        </button>
      </div>
      <div class="flex-1 overflow-y-auto p-4 pb-20">
        <div class="nested-toc" id="mobile-toc-container">
          {{ $customTOC | safeHTML }}
        </div>
      </div>

      <!-- Close Button at Bottom-Right -->
      <div class="absolute bottom-4 right-4 pointer-events-none">
        <button id="toc-mobile-close-bottom" class="bg-primary text-white p-4 rounded-full shadow-2xl hover:bg-primary-dark hover:shadow-3xl transition-all duration-200 backdrop-blur-sm pointer-events-auto border-2 border-white/20">
          <i class="fas fa-times text-lg"></i>
          <span class="sr-only">সূচিপত্র বন্ধ করুন</span>
        </button>
      </div>
    </div>
  </div>

  <style>
    /* Nested TOC Styles */
    .nested-toc {
      --indent-size: 1.5rem;
      --line-color: #e2e8f0;
      --primary-color: #a05054;
      --text-muted: #6b7280;
    }

    /* Reset base styles */
    .nested-toc ul {
      list-style: none;
      padding: 0;
      margin: 0;
    }

    .nested-toc li {
      margin: 0;
    }

    /* Base link styles */
    .nested-toc a {
      display: flex;
      align-items: center;
      padding: 0.625rem 0.875rem;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 600;
      font-size: 1.15rem;
      border-radius: 0.5rem;
      transition: all 0.2s ease;
      position: relative;
      border-left: 3px solid transparent;
    }

    /* H2 links (main items) */
    .nested-toc > ul > li > a {
      font-size: 1.2rem;
      font-weight: 700;
      padding: 0.75rem 1rem;
    }

    /* H3 links (sub items) - aligned with tree lines */
    .nested-toc > ul > li > ul > li > a {
      font-size: 1.1rem;
      font-weight: 600;
      padding-left: 3rem; /* Aligns after tree structure */
    }

    /* H4 links (child items) */
    .nested-toc > ul > li > ul > li > ul > li > a {
      font-size: 1.05rem;
      font-weight: 500;
      padding-left: 4.5rem; /* Deeper indentation */
    }

    /* Arrow for expand/collapse */
    .nested-toc .toc-arrow {
      margin-right: 0.5rem;
      font-size: 0.75rem;
      width: 1rem;
      text-align: center;
      flex-shrink: 0;
      cursor: pointer;
      transition: transform 0.2s ease;
      opacity: 0.7;
    }

    .nested-toc .toc-arrow:hover {
      opacity: 1;
    }

    .nested-toc .toc-arrow.expanded {
      transform: rotate(90deg);
    }

    /* Circle indicator for standalone items */
    .nested-toc .toc-circle {
      margin-right: 0.5rem;
      font-size: 0.5rem;
      width: 1rem;
      text-align: center;
      flex-shrink: 0;
      color: var(--line-color);
    }

    /* Folder icon styles */
    .nested-toc .toc-icon {
      margin-right: 0.5rem;
      font-size: 0.875rem;
      width: 1.2rem;
      text-align: center;
      flex-shrink: 0;
    }

    /* Expandable containers */
    .nested-toc .toc-children {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease;
    }

    .nested-toc .toc-children.expanded {
      max-height: 2000px;
    }

    /* Tree structure lines matching requested format */
    .nested-toc > ul > li > ul {
      position: relative;
      padding-left: 2rem;
    }

    /* Main vertical line from parent to children */
    .nested-toc > ul > li > ul::before {
      content: '';
      position: absolute;
      left: 0.75rem;
      top: 0;
      bottom: 0;
      width: 1px;
      background-color: var(--line-color);
    }

    .nested-toc > ul > li > ul > li {
      position: relative;
    }

    /* Horizontal line (branch) to each child */
    .nested-toc > ul > li > ul > li::before {
      content: '';
      position: absolute;
      left: 0.75rem;
      top: 1.25rem;
      width: 1.25rem;
      height: 1px;
      background-color: var(--line-color);
    }

    /* Last child gets corner instead of line */
    .nested-toc > ul > li > ul > li:last-child::before {
      background: linear-gradient(to right, var(--line-color) 0%, var(--line-color) 1.25rem, transparent 1.25rem, transparent 100%);
    }

    /* Deeper level lines (H4 items under H3) */
    .nested-toc > ul > li > ul > li > ul {
      position: relative;
      padding-left: 1.5rem;
    }

    .nested-toc > ul > li > ul > li > ul::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 1px;
      background-color: var(--line-color);
    }

    .nested-toc > ul > li > ul > li > ul > li::before {
      content: '';
      position: absolute;
      left: 0;
      top: 1.25rem;
      width: 1rem;
      height: 1px;
      background-color: var(--line-color);
    }

    /* Hover and active states */
    .nested-toc a:hover {
      background-color: #f1f5f9;
      color: var(--primary-color);
      transform: translateX(2px);
      border-left-color: var(--primary-color);
    }

    .nested-toc a.active {
      background-color: #fef2f2;
      color: var(--primary-color);
      border-left-color: var(--primary-color);
      font-weight: 700;
      box-shadow: 0 2px 4px rgba(160, 80, 84, 0.1);
    }

    .nested-toc a.active .toc-icon,
    .nested-toc a.active .toc-arrow,
    .nested-toc a.active .toc-circle {
      color: var(--primary-color);
      opacity: 1;
    }

    /* Mobile TOC Sheet Styles */
    @media (max-width: 1023px) {
      #toc-mobile-toggle {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }

      /* Toggle button icon changes */
      #toc-mobile-toggle .toc-icon-open {
        transition: opacity 0.2s ease;
      }

      #toc-mobile-toggle .toc-icon-close {
        transition: opacity 0.2s ease;
      }

      #toc-mobile-toggle.toc-open .toc-icon-open {
        display: none;
      }

      #toc-mobile-toggle.toc-open .toc-icon-close {
        display: inline;
      }

      /* Enhanced visibility when TOC is open */
      #toc-mobile-toggle.toc-open {
        transform: scale(1.1);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.4);
      }

      #toc-mobile-sheet.open {
        transform: translateX(0);
      }

      #toc-mobile-overlay.open {
        opacity: 1;
        visibility: visible;
      }

      /* Mobile nested TOC styles */
      .nested-toc a {
        min-height: 48px;
        font-size: 1.2rem;
        padding: 0.75rem 1rem;
      }

      .nested-toc > ul > li > a {
        font-size: 1.3rem;
        font-weight: 700;
        padding: 0.875rem 1rem;
      }

      /* Mobile tree lines - same logic but touch-friendly */
      .nested-toc > ul > li > ul > li > a {
        font-size: 1.2rem;
        font-weight: 600;
        padding-left: 2.5rem;
        min-height: 52px;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      #toc-mobile-sheet {
        width: 100vw;
        max-width: 100vw;
      }

      #toc-mobile-toggle {
        bottom: 16px;
        right: 16px;
        padding: 0.875rem;
      }
    }
  </style>

  <script>
    // Fixed TOC Implementation for Hugo's flat structure
    class FixedTOC {
      constructor() {
        this.activeSection = null;
        this.collapsibleSections = [];
        this.init();
      }

      init() {
        // Process both desktop and mobile TOCs
        this.processTOC(document.getElementById('desktop-toc-container'));
        this.processTOC(document.getElementById('mobile-toc-container'));

        // Start all collapsed
        this.collapseAll();

        // Set up scroll listener
        this.setupScrollListener();
      }

      processTOC(container) {
        if (!container) return;

        const nav = container.querySelector('.table-of-contents');
        if (!nav) return;

        const list = nav.querySelector('ul');
        if (!list) return;

        const links = list.querySelectorAll('a');

        links.forEach((link, index) => {
          // Get the indentation from Hugo's inline style
          const style = link.getAttribute('style') || '';
          const marginLeft = this.getMarginLeft(style);

          // Determine the level based on margin-left
          const level = this.getLevelFromMargin(marginLeft);

          // Add appropriate icon
          this.addIcon(link, level);

          // Check if this is a main section (H2)
          if (level === 1) {
            if (this.hasNextLevel(links, index)) {
              this.makeCollapsible(link, links, index);
            } else {
              this.makeStandaloneItem(link);
            }
          }
        });
      }

      getMarginLeft(styleStr) {
        const match = styleStr.match(/margin-left:\s*(\d+(?:\.\d+)?)rem/);
        return match ? parseFloat(match[1]) : 0;
      }

      getLevelFromMargin(marginLeft) {
        if (marginLeft === 0) return 1; // H2 (main sections)
        if (marginLeft === 1) return 2; // H3 (sub sections)
        if (marginLeft >= 2) return 3; // H4+ (child sections)
        return 1;
      }

      hasNextLevel(links, currentIndex) {
        // Check if any subsequent link has a deeper level
        for (let i = currentIndex + 1; i < links.length; i++) {
          const nextStyle = links[i].getAttribute('style') || '';
          const nextMargin = this.getMarginLeft(nextStyle);
          if (nextMargin > 0) return true;
          if (nextMargin === 0) return false; // Reached next main section
        }
        return false;
      }

      addIcon(link, level) {
        // Skip if already processed
        if (link.hasAttribute('data-toc-processed')) return;

        const icon = document.createElement('i');
        icon.className = 'toc-icon fas';

        switch(level) {
          case 1:
            icon.classList.add('fa-folder');
            break;
          case 2:
            icon.classList.add('fa-file-alt');
            break;
          default:
            icon.classList.add('fa-angle-right');
        }

        link.insertBefore(icon, link.firstChild);
        link.setAttribute('data-toc-processed', 'true');
      }

      makeStandaloneItem(link) {
        // Add circle indicator for standalone main items
        const circle = document.createElement('i');
        circle.className = 'toc-circle fas fa-circle';
        circle.setAttribute('data-toc-circle', 'true');

        // Insert circle before the folder icon
        const folderIcon = link.querySelector('.toc-icon');
        if (folderIcon) {
          link.insertBefore(circle, folderIcon);
        }

        // Store reference
        link.tocCircle = circle;

        // Add click handler for navigation only
        link.addEventListener('click', (e) => {
          e.preventDefault();
          this.navigateToSection(this.getLinkId(link));
        });
      }

      makeCollapsible(link, allLinks, startIndex) {
        const linkId = this.getLinkId(link);

        // Create collapsible container
        const container = document.createElement('div');
        container.className = 'toc-children';
        container.setAttribute('id', `toc-children-${linkId}`);

        // Find all subsequent links that belong to this section
        const children = [];
        let endIndex = startIndex + 1;

        for (let i = startIndex + 1; i < allLinks.length; i++) {
          const childLink = allLinks[i];
          const childStyle = childLink.getAttribute('style') || '';
          const childMargin = this.getMarginLeft(childStyle);

          // Stop when we reach the next main section
          if (childMargin === 0) break;

          // Add to children
          children.push(childLink);
          endIndex = i;
        }

        // Move children to container
        children.forEach(childLink => {
          const li = childLink.parentElement;
          if (li.parentElement) {
            container.appendChild(li);
          }
        });

        // Insert container after the main link's li
        const parentLi = link.parentElement;
        parentLi.parentElement.insertBefore(container, parentLi.nextSibling);

        // Add expand/collapse arrow BEFORE the folder icon
        const arrow = document.createElement('i');
        arrow.className = 'toc-arrow fas fa-chevron-right';
        arrow.setAttribute('data-toc-arrow', 'true');

        // Insert arrow before the existing icon
        const existingIcon = link.querySelector('.toc-icon');
        if (existingIcon) {
          link.insertBefore(arrow, existingIcon);
        }

        // Store references
        link.tocContainer = container;
        link.tocArrow = arrow;
        link.tocIcon = existingIcon;

        // Track collapsible section
        this.collapsibleSections.push({ link, container });

        // Add click handler to link for navigation only
        link.addEventListener('click', (e) => {
          e.preventDefault();
          // Only navigate if not clicking on arrow
          if (!e.target.closest('[data-toc-arrow]')) {
            this.navigateToSection(linkId);
          }
        });

        // Add click handler to arrow for collapse/expand
        arrow.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation(); // Prevent link click
          this.toggleArrowCollapse(link);
        });

        // Add keyboard support
        link.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            this.handleMainSectionClick(link, linkId);
          }
        });
      }

      toggleArrowCollapse(link) {
        // Toggle collapse/expand when arrow is clicked
        const isExpanded = link.tocContainer && link.tocContainer.classList.contains('expanded');

        if (isExpanded) {
          // Collapse
          if (link.tocContainer) {
            link.tocContainer.classList.remove('expanded');
          }
          if (link.tocArrow) {
            link.tocArrow.classList.remove('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder-open');
            link.tocIcon.classList.add('fa-folder');
          }
        } else {
          // Expand
          if (link.tocContainer) {
            link.tocContainer.classList.add('expanded');
          }
          if (link.tocArrow) {
            link.tocArrow.classList.add('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder');
            link.tocIcon.classList.add('fa-folder-open');
          }
        }
      }

      handleMainSectionClick(link, linkId) {
        // For backward compatibility - not used anymore
        this.navigateToSection(linkId);
      }

      toggleCollapse(link) {
        // Toggle expand/collapse without navigation
        const isExpanded = link.tocContainer && link.tocContainer.classList.contains('expanded');

        if (isExpanded) {
          // Collapse the section
          if (link.tocContainer) {
            link.tocContainer.classList.remove('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder-open');
            link.tocIcon.classList.add('fa-folder');
          }
        } else {
          // Expand the section
          if (link.tocContainer) {
            link.tocContainer.classList.add('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder');
            link.tocIcon.classList.add('fa-folder-open');
          }
        }
      }

      expandSection(link) {
        // Simple toggle - no auto-collapse of other sections
        const isExpanded = link.tocContainer && link.tocContainer.classList.contains('expanded');

        if (isExpanded) {
          // User clicked to collapse
          if (link.tocContainer) {
            link.tocContainer.classList.remove('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder-open');
            link.tocIcon.classList.add('fa-folder');
          }
        } else {
          // User clicked to expand
          if (link.tocContainer) {
            link.tocContainer.classList.add('expanded');
          }
          if (link.tocIcon) {
            link.tocIcon.classList.remove('fa-folder');
            link.tocIcon.classList.add('fa-folder-open');
          }
        }
      }

      collapseAll() {
        // Start all collapsed (called only on init)
        this.collapsibleSections.forEach(({ link, container }) => {
          container.classList.remove('expanded');

          const icon = link.querySelector('.toc-icon');
          if (icon) {
            icon.classList.remove('fa-folder-open');
            icon.classList.add('fa-folder');
          }
        });
      }

      navigateToSection(linkId) {
        setTimeout(() => {
          const element = document.getElementById(linkId);
          if (element) {
            const header = document.getElementById('header');
            const headerHeight = header ? header.offsetHeight : 80;
            const offset = element.offsetTop - headerHeight - 20;

            window.scrollTo({
              top: Math.max(0, offset),
              behavior: 'smooth'
            });
          }
        }, 200);
      }

      getLinkId(link) {
        const href = link.getAttribute('href');
        return href ? href.replace('#', '') : '';
      }

      setupScrollListener() {
        window.addEventListener('scroll', () => {
          const sections = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
          const header = document.getElementById('header');
          const headerHeight = header ? header.offsetHeight : 80;
          const scrollPos = window.scrollY + headerHeight + 100;

          let currentSection = null;
          for (let i = sections.length - 1; i >= 0; i--) {
            const section = sections[i];
            if (scrollPos >= section.offsetTop) {
              currentSection = section.id;
              break;
            }
          }

          if (currentSection && currentSection !== this.activeSection) {
            this.activeSection = currentSection;
            this.expandSectionForId(currentSection);
          }
        });
      }

      expandSectionForId(sectionId) {
        // Find the TOC link for this section
        const sectionLink = document.querySelector(`.nested-toc a[href="#${sectionId}"]`);
        if (!sectionLink) return;

        // Find the parent main section (H2) for this section
        let currentElement = sectionLink.parentElement;
        while (currentElement && currentElement.classList) {
          const parentLi = currentElement.closest('li');
          if (parentLi) {
            const parentLink = parentLi.querySelector(':scope > a');
            if (parentLink && parentLink.tocContainer) {
              // Only expand if not already expanded (don't collapse others)
              if (!parentLink.tocContainer.classList.contains('expanded')) {
                if (parentLink.tocContainer) {
                  parentLink.tocContainer.classList.add('expanded');
                }
                if (parentLink.tocIcon) {
                  parentLink.tocIcon.classList.remove('fa-folder');
                  parentLink.tocIcon.classList.add('fa-folder-open');
                }
              }
              return;
            }
          }
          currentElement = currentElement.parentElement;
        }
      }
    }

    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
      new FixedTOC();
    });
  </script>
{{ end }}