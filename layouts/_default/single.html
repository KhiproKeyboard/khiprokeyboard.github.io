{{ define "main" }}
{{/* Check if this is a submodule page */}}
{{- $isSubmodule := false -}}
{{- $contentFile := "" -}}
{{- $processedContent := .Content -}}

{{- if or (eq .Section "installation") (eq .Layout "installation") -}}
  {{- $isSubmodule = true -}}
  {{- $contentFile = "content/installation/README.md" -}}
{{- else if or (eq .Section "documentation") (eq .Layout "documentation") -}}
  {{- $isSubmodule = true -}}
  {{- $contentFile = "content/documentation/README.md" -}}
{{- else if or (eq .Section "quickstart") (eq .Layout "quickstart") -}}
  {{- $isSubmodule = true -}}
  {{- $contentFile = "content/quickstart/README.md" -}}
{{- end -}}

{{- if $isSubmodule -}}
  {{- if fileExists $contentFile -}}
    {{- $rawContent := readFile $contentFile -}}
    {{- /* Split content and remove front matter */ -}}
    {{- $lines := split $rawContent "\n" -}}
    {{- $frontMatterEnd := 0 -}}
    {{- $inFrontMatter := false -}}
    {{- $frontMatterLines := 0 -}}

    {{- range $index, $line := $lines -}}
      {{- $trimmed := trim $line " \t\r\n" -}}
      {{- if eq $index 0 -}}
        {{- if eq $trimmed "---" -}}
          {{- $inFrontMatter = true -}}
        {{- end -}}
      {{- else if and $inFrontMatter (eq $trimmed "---") -}}
        {{- $frontMatterEnd = $index -}}
        {{- $inFrontMatter = false -}}
      {{- else if $inFrontMatter -}}
        {{- $frontMatterLines = add $frontMatterLines 1 -}}
      {{- end -}}
    {{- end -}}

    {{- if gt $frontMatterEnd 0 -}}
      {{- $contentLines := $lines | after (add $frontMatterEnd 1) -}}
      {{- $contentWithoutFrontMatter := delimit $contentLines "\n" -}}
      {{- $processedContent = $contentWithoutFrontMatter | markdownify -}}
    {{- else -}}
      {{- $processedContent = $rawContent | markdownify -}}
    {{- end -}}
    {{- /* Store in .Scratch for TOC to access */ -}}
    {{- .Scratch.Set "processedContent" $processedContent -}}
  {{- end -}}
{{- end -}}

{{/* Apply custom Banglish IDs to the processed content */}}
{{- $originalContent := $processedContent -}}
{{- $originalTOC := "" -}}

{{/* Generate TOC for submodules */}}
{{- if $isSubmodule -}}
  {{- $headings := findRE "<h([1-6])([^>]*id=\"[^\"]+\")?[^>]*>(.*?)</h[1-6]>" $processedContent -}}
  {{- $tocItems := slice -}}
  {{- $idMap := dict -}}

  {{- range $headings -}}
    {{- $level := . | replaceRE ".*<h([1-6]).*" "$1" | int -}}
    {{- $text := . | replaceRE "<[^>]*>" "" | replaceRE "</h[1-6]>" "" -}}
    {{- $banglishID := $text | partial "banglish-id" -}}
    {{- $existingID := "" -}}
    {{- if . | findRE "id=\"" -}}
      {{- $existingID = . | replaceRE ".*id=\"([^\"]+)\".*" "$1" -}}
      {{- $idMap = merge $idMap (dict $existingID $banglishID) -}}
    {{- end -}}
    {{- $tocItem := dict "level" $level "text" $text "id" $banglishID -}}
    {{- $tocItems = $tocItems | append $tocItem -}}
  {{- end -}}

  {{- /* Build TOC HTML with Banglish IDs */}}
  {{- if gt (len $tocItems) 0 -}}
    {{- $tocHTML := "<nav class=\"table-of-contents\"><ul style=\"list-style: none; padding-left: 0; margin: 0;\">" -}}
    {{- range $tocItems -}}
      {{- $tocHTML = printf "%s<li style=\"margin: 0.25rem 0;\"><a href=\"#%s\" style=\"display: block; padding: 0.5rem 0.75rem; border-radius: 0.375rem; text-decoration: none; font-size: 0.875rem; line-height: 1.25rem; transition: all 0.2s; border-left: 3px solid transparent; margin-left: %drem;\">%s</a></li>" $tocHTML .id (sub .level 1) .text -}}
    {{- end -}}
    {{- $tocHTML = printf "%s</ul></nav>" $tocHTML -}}
    {{- $originalTOC = $tocHTML -}}
    {{- /* Store in scratch for toc.html to access */ -}}
    {{- .Scratch.Set "processedTOC" $tocHTML -}}
  {{- end -}}
{{- else -}}
  {{- $originalTOC = .TableOfContents -}}
{{- end -}}

{{/* Replace Hugo-generated IDs with Banglish IDs in content */}}
{{- $headings := findRE "<h([1-6])([^>]*id=\"[^\"]+\")?[^>]*>(.*?)</h[1-6]>" $processedContent -}}
{{- $idMap := dict -}}

{{- range $headings -}}
  {{- $level := . | replaceRE ".*<h([1-6]).*" "$1" -}}
  {{- $text := . | replaceRE "<[^>]*>" "" | replaceRE "</h[1-6]>" "" -}}
  {{- $banglishID := $text | partial "banglish-id" -}}
  {{- $existingID := "" -}}
  {{- if . | findRE "id=\"" -}}
    {{- $existingID = . | replaceRE ".*id=\"([^\"]+)\".*" "$1" -}}
    {{- $idMap = merge $idMap (dict $existingID $banglishID) -}}
  {{- end -}}
{{- end -}}

{{/* Replace IDs in content */}}
{{- $finalContent := $processedContent -}}
{{- range $existingID, $banglishID := $idMap -}}
  {{- if $existingID -}}
    {{- $finalContent = replaceRE (printf "id=\"%s\"" $existingID) (printf "id=\"%s\"" $banglishID) $finalContent -}}
  {{- end -}}
{{- end -}}

{{/* Replace IDs in TOC */}}
{{- $finalTOC := $originalTOC -}}
{{- range $existingID, $banglishID := $idMap -}}
  {{- if $existingID -}}
    {{- $finalTOC = replaceRE (printf "href=\"#%s\"" $existingID) (printf "href=\"#%s\"" $banglishID) $finalTOC -}}
  {{- end -}}
{{- end -}}

<div class="min-h-screen pt-0 pb-20 md:pb-0" style="background-color: #ffffff;">
    <div class="flex flex-col lg:flex-row gap-4 sm:gap-6 p-2 sm:p-4 lg:p-8 pt-4 md:pt-8">
          <!-- TOC Sidebar -->
        {{ partial "toc.html" . }}

        <!-- Main Content Container -->
        <div class="flex-1 min-w-0 text-[1.12rem] leading-relaxed md:text-[1.2rem]">
        <div class="w-full">
            <!-- Main Content -->
            <main class="w-full">
                <article class="rounded-2xl shadow-lg p-4 sm:p-6 lg:p-12 w-full">
                    <!-- Page Header - Only show for non-submodule pages -->
                    {{ if not $isSubmodule }}
                    <header class="mb-4 pb-3 border-b border-gray-200">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-900 mb-2">
                            {{ .Title }}
                        </h1>
                        {{ if .Params.description }}
                        <p class="text-lg text-gray-600 leading-relaxed">
                            {{ .Params.description }}
                        </p>
                        {{ end }}
                    </header>
                    {{ end }}

                    <!-- Content -->
                    <div class="readme-content markdown-body single-page-content">
                        {{ if $isSubmodule }}
                            {{ if .Scratch.Get "processedContent" }}
                                {{ $finalContent | safeHTML }}
                            {{ else }}
                                <div class="alert alert-warning">
                                    <strong>সতর্কতা:</strong> {{ .Section }} content is currently unavailable.
                                    Please ensure the git submodule is properly initialized and updated.
                                    <br><br>
                                    You can initialize the submodules by running:
                                    <pre><code>git submodule update --init --recursive</code></pre>
                                    Or update existing submodules:
                                    <pre><code>git submodule update --remote --merge</code></pre>
                                </div>
                            {{ end }}
                        {{ else }}
                            {{ $finalContent | safeHTML }}
                        {{ end }}
                    </div>

                    <!-- Page Navigation -->
                    <nav class="mt-12 pt-8 border-t border-gray-200">
                        <div class="flex justify-between items-center">
                            {{ with .PrevInSection }}
                            <a href="{{ .RelPermalink }}" class="group flex items-center text-primary hover:text-primary-dark transition-colors">
                                <i class="fas fa-chevron-left mr-2 group-hover:-translate-x-1 transition-transform"></i>
                                <div class="text-left">
                                    <div class="text-sm text-gray-500">পূর্ববর্তী</div>
                                    <div class="font-semibold">{{ .Title }}</div>
                                </div>
                            </a>
                            {{ else }}
                            <div></div>
                            {{ end }}

                            {{ with .NextInSection }}
                            <a href="{{ .RelPermalink }}" class="group flex items-center text-primary hover:text-primary-dark transition-colors">
                                <div class="text-right">
                                    <div class="text-sm text-gray-500">পরবর্তী</div>
                                    <div class="font-semibold">{{ .Title }}</div>
                                </div>
                                <i class="fas fa-chevron-right ml-2 group-hover:translate-x-1 transition-transform"></i>
                            </a>
                            {{ end }}
                        </div>
                    </nav>
                </article>
            </main>
        </div>
        </div>
    </div>
</div>
{{ end }}