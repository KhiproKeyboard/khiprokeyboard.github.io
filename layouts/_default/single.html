{{ define "main" }}
{{/* =======================================================
DOCS PAGE LAYOUT - Collapsible Tree TOC
Auto-detects submodule folder from page path
======================================================= */}}

{{- $isSubmodule := false -}}
{{- $contentFile := "" -}}
{{- $processedContent := .Content -}}

{{/* Auto-detect submodule folder from current page path */}}
{{- $currentSection := .CurrentSection.RelPermalink -}}
{{- $currentRel := .RelPermalink -}}
{{- if or (eq $currentSection "/khipro/quickstart/") (eq $currentRel "/khipro/quickstart/") -}}
{{- $isSubmodule = true -}}
{{- $contentFile = "content/quickstart/README.md" -}}
{{- else if or (eq $currentSection "/khipro/installation/") (eq $currentRel "/khipro/installation/") -}}
{{- $isSubmodule = true -}}
{{- $contentFile = "content/installation/README.md" -}}
{{- else if or (eq $currentSection "/khipro/documentation/") (eq $currentRel "/khipro/documentation/") -}}
{{- $isSubmodule = true -}}
{{- $contentFile = "content/documentation/README.md" -}}
{{- end -}}

{{- if $isSubmodule -}}
{{- if fileExists $contentFile -}}
{{- $rawContent := readFile $contentFile -}}
{{- $lines := split $rawContent "\n" -}}
{{- $frontMatterEnd := 0 -}}
{{- $inFrontMatter := false -}}

{{- range $index, $line := $lines -}}
{{- $trimmed := trim $line " \t\r\n" -}}
{{- if eq $index 0 -}}
{{- if eq $trimmed "---" -}}
{{- $inFrontMatter = true -}}
{{- end -}}
{{- else if and $inFrontMatter (eq $trimmed "---") -}}
{{- $frontMatterEnd = $index -}}
{{- $inFrontMatter = false -}}
{{- end -}}
{{- end -}}

{{- if gt $frontMatterEnd 0 -}}
{{- $contentLines := $lines | after (add $frontMatterEnd 2) -}}
{{- $contentWithoutFrontMatter := delimit $contentLines "\n" -}}
{{- $processedContent = $contentWithoutFrontMatter | markdownify -}}
{{- else -}}
{{- $contentLines := $lines | after 1 -}}
{{- $contentWithoutFrontMatter := delimit $contentLines "\n" -}}
{{- $processedContent = $contentWithoutFrontMatter | markdownify -}}
{{- end -}}

{{- $processedContent = replaceRE "src=\"/img/" (printf "src=\"%s" ("img/" | relURL)) $processedContent -}}
{{- $processedContent = replaceRE "href=\"/img/" (printf "href=\"%s" ("img/" | relURL)) $processedContent -}}

{{/* Transform GitHub-style alerts: [!NOTE], [!TIP], etc. */}}
{{- $processedContent = $processedContent | replaceRE "(?s)<blockquote>\\s*<p>\\s*\\[!NOTE\\](?:<br>|\\s+)?(.*?)</p>\\s*
</blockquote>" "<div class=\"doc-alert doc-alert--note\">
  <div class=\"doc-alert__header\">
    <div class=\"doc-alert__icon\"><i class=\"fas fa-info-circle\"></i></div>
    <div class=\"doc-alert__content\"><strong>উল্লেখ্য</strong></div>
  </div>
  <div class=\"doc-alert__content\">$1</div>
</div>" -}}
{{- $processedContent = $processedContent | replaceRE "(?s)<blockquote>\\s*<p>\\s*\\[!TIP\\](?:<br>|\\s+)?(.*?)</p>\\s*
</blockquote>" "<div class=\"doc-alert doc-alert--tip\">
  <div class=\"doc-alert__header\">
    <div class=\"doc-alert__icon\"><i class=\"fas fa-lightbulb\"></i></div>
    <div class=\"doc-alert__content\"><strong>টিপস</strong></div>
  </div>
  <div class=\"doc-alert__content\">$1</div>
</div>" -}}
{{- $processedContent = $processedContent | replaceRE "(?s)<blockquote>\\s*<p>\\s*\\[!IMPORTANT\\](?:<br>|\\s+)?(.*?)
  </p>\\s*</blockquote>" "<div class=\"doc-alert doc-alert--important\">
  <div class=\"doc-alert__header\">
    <div class=\"doc-alert__icon\"><i class=\"fas fa-exclamation-circle\"></i></div>
    <div class=\"doc-alert__content\"><strong>গুরুত্বপূর্ণ</strong></div>
  </div>
  <div class=\"doc-alert__content\">$1</div>
</div>" -}}
{{- $processedContent = $processedContent | replaceRE "(?s)<blockquote>\\s*<p>\\s*\\[!WARNING\\](?:<br>|\\s+)?(.*?)</p>
  \\s*</blockquote>" "<div class=\"doc-alert doc-alert--warning\">
  <div class=\"doc-alert__header\">
    <div class=\"doc-alert__icon\"><i class=\"fas fa-exclamation-triangle\"></i></div>
    <div class=\"doc-alert__content\"><strong>সতর্কীকরণ</strong></div>
  </div>
  <div class=\"doc-alert__content\">$1</div>
</div>" -}}
{{- $processedContent = $processedContent | replaceRE "(?s)<blockquote>\\s*<p>\\s*\\[!CAUTION\\](?:<br>|\\s+)?(.*?)</p>
  \\s*</blockquote>" "<div class=\"doc-alert doc-alert--caution\">
  <div class=\"doc-alert__header\">
    <div class=\"doc-alert__icon\"><i class=\"fas fa-fire\"></i></div>
    <div class=\"doc-alert__content\"><strong>বিশেষ সতর্কীকরণ</strong></div>
  </div>
  <div class=\"doc-alert__content\">$1</div>
</div>" -}}

{{- .Scratch.Set "processedContent" $processedContent -}}
{{- end -}}
{{- end -}}

{{/*
SYNC IDs: Hugo generates Bengali IDs, but we want Banglish IDs for better compatibility.
We map original IDs to Banglish IDs and replace them in the content.
*/}}
{{- $idMap := dict -}}
{{- $tocData := slice -}}

{{- if $isSubmodule -}}
{{/* 1. Add page title as first H1 */}}
{{- $tocData = $tocData | append (dict "level" 1 "text" .Title "id" "top") -}}

{{/* 2. Find all headings to build ID map and TOC data */}}
{{- $headingBlocks := findRE "<h([1-6])([^>]*)?>(.*?)</h[1-6]>" $processedContent -}}
  {{- range $headingBlocks -}}
  {{- $level := . | replaceRE ".*<h([1-6]).*" "$1" | int -}} {{- $rawText :=. | replaceRE "<[^>]*>" "" -}} {{- $text
    :=$rawText | htmlUnescape -}} {{/* Extract existing ID from heading tag if it exists */}} {{- $existingID :="" -}}
    {{- if findRE "id=\" ([^\"]+)\"" . -}} {{- $existingID=. | replaceRE ".*id=\" ([^\"]+)\".*" "$1" -}} {{- end -}}
    {{/* Generate Banglish ID */}} {{- $banglishID :=$text | partial "banglish-id" -}} {{/* If heading already has an
    ID, map it to Banglish ID */}} {{- if $existingID -}} {{- $idMap=merge $idMap (dict $existingID $banglishID) -}} {{-
    end -}} {{- $tocData=$tocData | append (dict "level" $level "text" $text "id" $banglishID) -}} {{- end -}} {{/* 3.
    Replace IDs in content */}} {{- $finalContent :=$processedContent -}} {{- range $oldID, $newID :=$idMap -}} {{-
    $finalContent=replace $finalContent (printf "id=\" %s\"" $oldID) (printf "id=\" %s\"" $newID) -}} {{/* Also fix any
    internal links that might use the old IDs */}} {{- $finalContent=replace $finalContent (printf "href=\" #%s\""
    $oldID) (printf "href=\" #%s\"" $newID) -}} {{- end -}} {{- .Scratch.Set "finalContent" $finalContent -}} {{- end
    -}} {{/* Check which items have children - H1 with H2/H3 following */}} {{- $hasChildren :=dict -}} {{- range
    $index, $item :=$tocData -}} {{- $nextIndex :=add $index 1 -}} {{- if lt $nextIndex (len $tocData) -}} {{- $nextItem
    :=index $tocData $nextIndex -}} {{- if gt $nextItem.level $item.level -}} {{- $hasChildren=merge $hasChildren (dict
    (string $index) true) -}} {{- end -}} {{- end -}} {{- end -}} <div class="doc-layout">
    <aside class="doc-sidebar">
      <div class="doc-toc">
        <div class="doc-toc__header">
          <div class="doc-toc__icon">
            <i class="fas fa-list"></i>
          </div>
          <h2 class="doc-toc__title">সূচিপত্র</h2>
        </div>

        {{ if gt (len $tocData) 0 }}
        <nav class="doc-toc__nav" aria-label="Table of Contents">
          <ul class="doc-toc__list" role="list" id="doc-toc-list">
            {{- range $index, $item := $tocData -}}
            {{- $hasChild := index $hasChildren (string $index) -}}
            {{- $isH1 := eq $item.level 1 -}}
            {{- $isH2 := eq $item.level 2 -}}

            <li
              class="doc-toc__item doc-toc__item--level-{{ $item.level }}{{ if $hasChild }} doc-toc__item--has-children{{ end }}"
              data-toc-item>
              <a href="#{{ $item.id }}" class="doc-toc__link" data-toc-link>
                <span class="doc-toc__indicators">
                  {{- if $hasChild -}}
                  <span class="doc-toc__arrow" data-toc-arrow>
                    <i class="fas fa-chevron-right"></i>
                  </span>
                  {{- else if $isH1 -}}
                  <span class="doc-toc__dot">
                    <i class="fas fa-circle"></i>
                  </span>
                  {{- end -}}
                </span>

                <span class="doc-toc__level-icon">
                  {{- if $isH1 -}}
                  <span class="doc-toc__folder" data-toc-folder>
                    <i class="fas fa-folder"></i>
                  </span>
                  {{- else if $isH2 -}}
                  <span class="doc-toc__file" data-toc-icon>
                    <i class="fas fa-file-alt"></i>
                  </span>
                  {{- else -}}
                  <span class="doc-toc__angle">
                    <i class="fas fa-angle-right"></i>
                  </span>
                  {{- end -}}
                </span>

                <span class="doc-toc__text">{{ $item.text }}</span>
              </a>
            </li>
            {{- end -}}
          </ul>
        </nav>
        {{ else }}
        <div class="doc-toc__empty">
          <div class="doc-toc__empty-icon">
            <i class="fas fa-inbox"></i>
          </div>
          <p class="doc-toc__empty-text">কোনো বিষয়বস্তু নেই</p>
        </div>
        {{ end }}
      </div>
    </aside>

    <main class="doc-main" role="main" id="top">
      <article class="doc-article">
        <header class="doc-article__header">
          <div class="doc-article__meta">
            <span class="doc-article__type">ডকুমেন্টেশন</span>
          </div>
          <h1 class="doc-article__title">{{ .Title }}</h1>
          {{ with .Params.description }}
          <p class="doc-article__description">{{ . }}</p>
          {{ end }}
        </header>

        <div class="doc-article__content">
          {{ if and $isSubmodule (not (fileExists $contentFile)) }}
          <div class="doc-alert doc-alert--warning">
            <div class="doc-alert__header">
              <div class="doc-alert__icon">
                <i class="fas fa-exclamation-triangle"></i>
              </div>
              <div class="doc-alert__content">
                <strong>সতর্কতা:</strong> কন্টেন্ট পাওয়া যায়নি।
              </div>
            </div>
            <div class="doc-alert__content">
              <p>গিট সাবমোডিউল আপডেট করুন:</p>
              <pre><code>git submodule update --init --recursive</code></pre>
            </div>
          </div>
          {{ else }}
          {{ .Scratch.Get "finalContent" | safeHTML }}
          {{ end }}
        </div>
      </article>
    </main>
    </div>

    <div class="doc-toc-drawer" id="doc-toc-drawer" aria-hidden="true">
      <div class="doc-toc-drawer__overlay" data-doc-toc-overlay></div>
      <div class="doc-toc-drawer__panel">
        <header class="doc-toc-drawer__header">
          <h2 class="doc-toc-drawer__title">সূচিপত্র</h2>
          <button class="doc-toc-drawer__close" type="button" aria-label="বন্ধ করুন" data-doc-toc-close>
            <i class="fas fa-times"></i>
          </button>
        </header>
        <div class="doc-toc-drawer__body" data-doc-toc-clone></div>
      </div>
    </div>

    {{ if gt (len $tocData) 0 }}
    <button class="doc-toc-fab" type="button" aria-label="সূচিপত্র দেখুন" aria-expanded="false"
      aria-controls="doc-toc-drawer" data-doc-toc-toggle>
      <i class="fas fa-bars"></i>
    </button>
    {{ end }}

    {{ end }}